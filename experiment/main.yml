---
- name: Initialise Vagrant
  hosts: localhost
  vars_files:
    - "{{ lookup('ansible.builtin.env', 'HOME') }}/workspace/projects/ansible-server/infra/vars/main.yml"
  tasks:
    - name: Check if the IP is in the list
      ansible.builtin.command: grep -q 'http://hello-this-works' "{{ local_project_directory }}/experiment/settings.py"
      register: ip_check
      changed_when: false
      ignore_errors: true

    - name: Set a variable based on file content
      ansible.builtin.set_fact:
        file_contains_ip: "{{ 'http://hello-this-works' in lookup('file', '{{ local_project_directory }}/experiment/settings.py') }}"

    - name: Update the list if IP is not present
      ansible.builtin.replace:
        path: "{{ local_project_directory }}/experiment/settings.py"
        regexp: '(CORS_ALLOWED_ORIGINS = \[)'
        replace: '\1\n\t"http://hello-this-works",'
      when: ip_check.rc != 0

    - name: Replace existing IP with http://10.2.2.202
      ansible.builtin.replace:
        path: "{{ local_project_directory }}/experiment/settings.py"
        regexp: '"http://10.2.2[^"]*"'
        replace: '"http://hello-this-works"'
      when: ip_check.rc == 0 and not file_contains_ip
